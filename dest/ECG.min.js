var ECG=function(){var e={ecgDom:{c:{},c_in:{},bc:null,fc:[],t:null,tc:null},context:{bcContext:null,fcContext:null,tcContext:null},width:1e3,height:500,marginL:1,tWidth:1001,cellWidth:50,cellHeight:50,ifReposition:!0,descriptionWords:{style:{V1:{ifDraw:!0,index:1,text:"V1"},V5:{ifDraw:!0,index:4,text:"V5"},aVF:{ifDraw:!0,index:7,text:"aVF"},Pacer:{ifDraw:!0,index:9,text:"Pacer"}}},bc:{},fc:{gain:{std:10,cur:10,mul:1},ps:{std:25,cur:25,mul:1},coordinate:{V1:{x:0,y:50},V5:{x:0,y:200},aVF:{x:0,y:350},Pacer:{x:0,y:450}},fcWidth:3e3,fcNum:6,drawIndex:0,pxPerData:2},tc:{name:"V1",coordinate:{x:0,y:0},line:1,pxPerData:1,pxPerMv:15,space:25,sWidth:200,sHeight:20},rowsPerLine:5,colsPerSecond:5,isInit:!1,ifPoint:!0,rate:125,ecgData:{result:{},ecgPartBlocks:[],hwLeadConfig:[],avgLead:[]},theme:{background:"#fff",font:"#000",grid:"#ff859d",line:"#000",lineWidth:1,dotWidth:1,optionColor:"#2ac8c7"},themes:{"default":{background:"#fff",font:"#000",grid:"#ff859d",line:"#000",lineWidth:1,dotWidth:1},theme2:{background:"#333",font:"#3ff936",grid:"#ccc",line:"#3ff936",lineWidth:1,dotWidth:1},theme3:{background:"#eff9ff",font:"#000",grid:"#ccc",line:"#007cab",lineWidth:1,dotWidth:1}}},t={c:{width:"100%",overflowX:"scroll",overflowY:"hidden",backgroundRepeat:"no-repeat"},c_in:{width:"18000px",fontSize:"0px"},bc:{display:"none"}},r={t:{width:"100%",height:"254px"},tc:{}},o={checkECGContainer:function(t){var r=document.getElementById(t);return r?(e.ecgDom.c=r,!0):(console.error("未找到ECG容器。"),!1)},checkThumbnailContainer:function(t){var r=document.getElementById(t);return r?(e.ecgDom.t=r,!0):(console.error("未找到缩略图容器"),!1)},createCanvas:function(t){var r=document.createElement("canvas");return r.height=e.height,t?(r.width=2*e.width,r.id="bc"):(r.width=e.fc.fcWidth,r.style["float"]="left",r.className="fc"),r},createThumbnailC:function(){if(!e.ecgDom.t)return console.error("can not find thumbnail container"),!1;var t=document.createElement("canvas"),o=e.ecgDom.t;return t.width=o.clientWidth,t.height=parseInt(r.t.height),t.id="tc",e.ecgDom.tc=t,t},setECGBackground:function(){var t=e.ecgDom.bc.toDataURL();return e.ecgDom.c.style.backgroundImage="url("+t+")",!0},setThumbnailBg:function(){var t=e.ecgDom.tc.toDataURL();return e.ecgDom.t.style.backgroundImage="url("+t+")",c.clearTc(),!0},getBaseY:function(t){var r=e.descriptionWords.style[t].index;return e.cellHeight*r},drawECG:function(t,r){var n=e.fc.coordinate[t],c=e.fc.gain.mul,i=e.fc.pxPerData,a=o.getBaseY(t),l=n.x+i,d=.5/e.cellHeight,s=Math.floor(a-r/d*c)+.5;l>e.fc.fcWidth&&(this.resetCoordinateByName(t),e.fc.drawIndex++,e.fc.drawIndex<e.ecgDom.fc.length?e.context.fcContext=e.ecgDom.fc[e.fc.drawIndex].getContext("2d"):(e.fc.drawIndex=0,e.context.fcContext=e.ecgDom.fc[e.fc.drawIndex].getContext("2d")),l=0);var f=e.context.fcContext;f.beginPath(),f.strokeStyle=e.theme.line,f.moveTo(n.x,n.y),f.lineTo(l,s),n.x=l,n.y=s,f.stroke()},isArray:function(e){return!(!e||"[object Array]"!=Object.prototype.toString.call(e))},isString:function(e){return!(!e||"[object String]"!=Object.prototype.toString.call(e))},isNumber:function(e){return!(!e||"[object Number]"!=Object.prototype.toString.call(e))},isObject:function(e){return!(!e||"[object Object]"!=Object.prototype.toString.call(e))},getAllSelectedEcg:function(e){for(var t='input[name="'+e+'"]:checked',r=document.querySelectorAll(t),o=r.length,n=[],c=0;c<o;c++){var i=r[c].value;n.push(i)}return n},resetAllCoordinate:function(t){for(var r=e.fc.coordinate,o=Object.keys(r),n=o.length,c=0;c<n;c++){var i=o[c];r[i].x=0,t&&(r[i].y=e.descriptionWords.style[i].index*e.cellHeight)}return!0},resetCoordinateByName:function(t,r){var o=e.fc.coordinate;return r&&(o[t].y=0),o[t].x=0,!0},getEcgIndex:function(t){return t&&this.isString(t)?e.ecgData.hwLeadConfig.indexOf(t):(console.error("error: parameter is wrong."),!1)},getAllDrawECG:function(){for(var t=e.descriptionWords.style,r=Object.keys(t),o=[],n=r.length,c=0;c<n;c++){var i=r[c];t[i].ifDraw&&o.push(i)}return o},drawCols:function(){var t=e.cellWidth,r=e.context.bcContext;t||(t=50),r.strokeStyle=e.theme.grid,r.lineWidth=e.theme.lineWidth;var o=t+e.marginL,n=2*e.width,c=1;for(o;o<n;o+=t)c%e.colsPerSecond==0?(r.beginPath(),r.lineWidth=2,r.moveTo(o,0),r.lineTo(o,e.height)):(r.beginPath(),r.lineWidth=1,r.moveTo(o+.5,0),r.lineTo(o+.5,e.height)),r.stroke(),c++},drawRows:function(){var t=e.cellHeight,r=e.context.bcContext;t||(t=cellWidth),r.beginPath(),r.strokeStyle=e.theme.grid;for(var o=1,n=t;n<e.height;n+=t)o%e.rowsPerLine==0?(r.beginPath(),r.lineWidth=2,r.moveTo(e.marginL,n),r.lineTo(2*e.width,n)):(r.beginPath(),r.lineWidth=1,r.moveTo(e.marginL,n+.5),r.lineTo(2*e.width,n+.5)),r.stroke(),o++},drawPoints:function(){var t=e.ifPoint;if(t){var r=Math.floor(e.cellWidth/5),o=e.context.bcContext;o.fillStyle=e.theme.grid;var n=r+e.marginL;for(n;n<2*e.width;n+=r)if((n-e.marginL)%e.cellWidth!=0)for(var c=r;c<e.height;c+=r)c%e.cellHeight!=0&&o.rect(n,c,e.theme.dotWidth,e.theme.dotWidth);o.fill()}},drawTime:function(t,r){var o=e.context.fcContext,n=e.fc.coordinate[r],c=n.x;return o.save(),o.beginPath(),o.fillStyle=e.theme.font,o.fillText(t,c,20),o.restore(),!0},setCInWidth:function(r){return this.isNumber(r)?(t.c_in.width=r+"px",e.ecgDom.c_in.style.width=t.c_in.width,!0):(console.error("error: number is required, but "+typeof r+" is given."),!1)},fillCIn:function(){var t=e.ecgDom.c_in,r=e.ecgDom.bc,n=e.ecgDom.fc;if(r)try{t.removeChild(r)}catch(c){console.error(c)}finally{e.ecgDom.bc=null}for(var i=0;i<n.length;i++)try{t.removeChild(n[i])}catch(c){console.error(c)}e.ecgDom.fc=[],e.ecgDom.bc=o.createCanvas(!0),e.context.bcContext=e.ecgDom.bc.getContext("2d"),e.ecgDom.c_in.appendChild(e.ecgDom.bc);for(var a=0;a<e.fc.fcNum;a++){var l=o.createCanvas(!1);l.id="fc"+a,e.ecgDom.fc.push(l),e.ecgDom.c_in.appendChild(l)}},initScrollVal:function(t,r){var o=e.ecgDom.c,n=0;if(t){if("number"!=typeof t)return console.error("number required but "+typeof t+"given."),!1;n=r?o.scrollLeft-t:o.scrollLeft+t}else n=r?o.scrollLeft-o.offsetWidth:o.scrollLeft+o.offsetWidth;return n},repositionECG:function(){if(!e.ifReposition)return!1;var t=e.height,r=e.cellHeight,n=e.descriptionWords.style,c=o.getAllDrawECG(),i=c.length,a=t/r,l=Math.floor(a/2);if(1==i%2)for(var d=Math.floor(i/2),s=(l/(d+1)).toFixed(1),f=0;f<i;f++)f<d?n[c[f]].index=(f+1)*s:f==d?n[c[f]].index=l:n[c[f]].index=l+(f-d)*s;else for(var s=Math.floor((a-1)/i),f=0;f<i;f++)n[c[f]].index=s*(f+1);this.resetAllCoordinate(!0)},drawThumbnailBg:function(){var t=e.theme,r=e.context.tcContext,o=e.ecgDom.tc,n=o.width,c=o.height;r.lineWidth=2,r.strokeStyle=t.grid,r.rect(1,1,n-2,c-2),r.stroke(),r.lineWidth=1,r.strokeStyle=t.grid;for(var i=1.5+e.cellHeight;i<c;i+=e.cellHeight)r.moveTo(0,i),r.lineTo(n,i);for(var a=1.5+e.cellWidth;a<n;a+=e.cellWidth)r.moveTo(a,0),r.lineTo(a,c);r.stroke(),r.beginPath();var l=e.cellWidth/5,d=e.cellHeight/5;r.fillStyle=t.grid;for(var i=1+l;i<n;i+=l)for(var a=1+d;a<c;a+=d)r.rect(i,a,t.dotWidth,t.dotWidth);return r.fill(),this.setThumbnailBg(),!0},getCoordinateInCanvas:function(t,r){var o=e.ecgDom.tc,n=o.getBoundingClientRect(),c=document.body,i=c.scrollLeft,a=c.scrollTop,l=a+n.top-document.documentElement.clientTop,d=i+n.left-document.documentElement.clientLeft;return{x:t-d,y:r-l}},addHandlerToTc:function(){var t=e.ecgDom.tc;t.addEventListener?t.addEventListener("click",c.selectTc):t.attachEvent?t.attachEvent("onclick",c.selectTc):t.onclick=c.selectTc},getLineNumInTc:function(t){return parseInt((t/e.tc.space).toFixed(0))},moveSelectedAreaIntoView:function(t,r){var o=e.ecgDom.tc.width,t=(r-1)*o+t,c=t*(e.fc.pxPerData/e.tc.pxPerData);n.scrollLR(c)}},n={setStyle:function(e){if(!ECG.doc.isInit)return console.error("ECG对象未初始化"),!1;if("object"!=typeof e)return console.error("setStyle参数错误"),!1;for(var t=Object.keys(e),r=t.length,o=0;o<r;o++)for(var n=t[o],c=Object.keys(e[n]),i=c.length,a=0;a<i;a++){var l=c[a];ECG.doc.ecgDom[n].style[l]=e[n][l]}return!0},setCell:function(t,r){e.cellWidth=t,e.cellHeight=r,c.drawBc()},setDescriptionWordsStyle:function(t){if("object"!=typeof t)return console.error("The type of param must be object."),!1;for(var r=e.descriptionWords.style,o=Object.keys(t),n=o.length,i=0;i<n;i++){var a=o[i];if(r.hasOwnProperty(a))for(var l=r[a],d=Object.keys(t[a]),s=d.length,f=0;f<s;f++){var h=d[f];l.hasOwnProperty(h)&&(l[h]=t[a][h])}}return!!c.drawBc()},setDescriptionWords:function(){var t=e.descriptionWords.style,r=Object.keys(t),o=e.context.bcContext;o.save();for(var n=r.length,c=0;c<n;c++){var i=r[c],a=t[i];if(a.ifDraw){o.beginPath(),o.fillStyle=e.theme.font;var l=e.marginL,d=a.index*e.cellHeight;o.fillText(a.text,l,d)}}return o.restore(),!0},setBorder:function(){var t=e.context.bcContext;t.beginPath(),t.strokeStyle=e.theme.grid,t.lineWidth=2,t.rect(e.marginL,1,2*e.width,e.height-1),t.stroke(),o.setECGBackground()},setEcgData:function(t){if(!t||!o.isObject(t))return console.error("error: the param is wrong, please check the input param."),!1;var r=e.ecgData;return r.result=t,r.hwLeadConfig=t.hwLeadConfig,r.ecgPartBlocks=t.ecgPartBlocks,r.avgLead=t.avgLead,!0},getAllThemes:function(){return Object.keys(e.themes)},setTheme:function(t){if(!t||!o.isString(t))return console.error("error: parameter is wrong, type String expected."),!1;if(!e.themes.hasOwnProperty(t))return console.error("error: name can not find in doc.themes, please check."),!1;var r=e.themes[t];e.theme=r;var n=document.querySelector("#canvas");return n.style.backgroundColor=r.background,!!c.drawBc()&&!!c.drawFc()},scrollLeft:function(t){var r=o.initScrollVal(t);return!1!==r&&(e.ecgDom.c.scrollLeft=r,!0)},scrollRight:function(t){var r=o.initScrollVal(t,!0);return!1!==r&&(e.ecgDom.c.scrollLeft=r,!0)},scrollLR:function(t){if(o.isNumber(t))return e.ecgDom.c.scrollLeft=t,!0;throw new TypeError("function scrollLR, val: number required, but "+typeof t+" is given.")},scrollTop:function(){for(var t=e.descriptionWords.style,r=Object.keys(t),o=r.length,n=0;n<o;n++){var i=r[n];t[i].index--}e.ifReposition=!1,c.drawBc(),c.drawFc(),e.ifReposition=!0},scrollBottom:function(){for(var t=e.descriptionWords.style,r=Object.keys(t),o=r.length,n=0;n<o;n++){var i=r[n];t[i].index++}e.ifReposition=!1,c.drawBc(),c.drawFc(),e.ifReposition=!0}},c={init:function(r){if("object"!=typeof r)return void console.error("配置信息错误,请以对象的形式传入配置信息。");if(!("id"in r))return console.error("配置信息错误,找不到ECG容器。"),!1;var c=o.checkECGContainer(r.id);if(!c)return void console.error("ECG can not find by id");var i=document.createElement("div");i.id="c_in",e.ecgDom.c_in=i,e.ecgDom.c.appendChild(i),o.fillCIn(),e.context.bcContext=e.ecgDom.bc.getContext("2d"),e.context.fcContext=e.ecgDom.fc[e.fc.drawIndex].getContext("2d"),e.isInit=!0,n.setStyle(t),this.drawBc()},initThumbnail:function(t){if("object"!=typeof t)return console.error("配置信息错误,请以对象的形式传入参数"),!1;if("id"in t){if(!o.checkThumbnailContainer(t.id))return!1;var n=o.createThumbnailC();if(!n)return console.log("generate thumbnail canvas error, stream is interrupted."),!1;e.ecgDom.t.appendChild(n);var c=e.ecgDom;for(var i in r)for(var a in r[i])c[i].style[a]=r[i][a];e.context.tcContext=e.ecgDom.tc.getContext("2d"),o.drawThumbnailBg(),o.addHandlerToTc()}},drawBc:function(){var t=e.ecgDom.bc,r=e.context.bcContext;return t?(r.clearRect(e.marginL,0,e.tWidth,e.height),n.setBorder(r),o.drawCols(),o.drawRows(),o.repositionECG(),o.drawPoints(),n.setDescriptionWords(),o.setECGBackground(),!0):(console.error("drawBc参数错误,未设置canvas或者找不到指定的canvas"),!1)},clearFc:function(){for(var t=e.ecgDom.fc,r=t.length,n=0;n<r;n++){var c=t[n],i=c.getContext("2d"),a=c.width,l=c.height;i.clearRect(0,0,a,l)}return o.resetAllCoordinate(!0),e.fc.drawIndex=0,e.context.fcContext=e.ecgDom.fc[0].getContext("2d"),!0},clearTc:function(){var t=e.context.tcContext,r=e.ecgDom.tc.width,o=e.ecgDom.tc.height;return t.clearRect(0,0,r,o),!0},hideECG:function(t){if(t){var r=e.descriptionWords.style;if(!o.isArray(t))return r[t]?(r[t].ifDraw=!1,this.drawBc(),this.drawFc(),!0):(console.error("error: could not find "+t+" in doc.descriptionWords.style"),!1);for(var n=t.length,c=0;c<n;c++){var i=t[c];return r[i]?(r[i].ifDraw=!1,this.drawBc(),this.drawFc(),!0):(console.error("error: could not find "+i+" in doc.descriptionWords.style"),!1)}}},showECG:function(t){if(t){var r=e.descriptionWords.style;if(!o.isArray(t))return r[t]?(r[t].ifDraw=!0,this.drawBc(),this.drawFc(),!0):(console.error("error: can not find "+t+" doc.descriptionWords.style."),!1);for(var n=t.length,c=0;c<n;c++){var i=t[c];return r[i]?(r[i].ifDraw=!0,this.drawBc(),this.drawFc(),!0):(console.error("error: can not find "+t+" in doc.descriptionWords.style."),!1)}}},setGain:function(t){if(!o.isNumber(t))return console.error("error: the type of val is not Number but "+Object.prototype.toString.call(t)),!1;e.fc.gain.cur=t,e.fc.gain.mul=t/e.fc.gain.std;var r=this.drawFc();return!!r},setPs:function(r){if(!o.isNumber(r))return console.error("error: the type of the val is not Number but"+Object.prototype.toString.call(r)),!1;e.fc.ps.cur=r;var c=r/e.fc.ps.std;e.fc.ps.mul=c,e.fc.pxPerData=e.cellWidth*e.colsPerSecond*c/e.rate;var i=e.cellWidth*e.colsPerSecond*72*c;e.fc.fcNum=Math.ceil(i/e.fc.fcWidth);var a=e.fc.fcNum*e.fc.fcWidth;return o.setCInWidth(a),o.fillCIn(),this.drawBc(),n.setStyle(t),!!this.drawFc()},drawFc:function(){this.clearFc();for(var t=e.ecgData,r=t.ecgPartBlocks,n=o.getAllDrawECG(),c=n.length,i=t.avgLead,a=0;a<c;a++)for(var l=n[a],d=o.getEcgIndex(l),s=0;s<18;s++){var f=r[s],h=f.ecgPartBlockData,g=f.ecgPartBlockHead,u=h[d],m=u.length;if(0==a){var v=g.headTime+" 心率: "+g.hrVal;o.drawTime(v,n[0])}for(var p=0;p<m;p++){var x=u[p];i&&(x-=i[d]),o.drawECG(l,x)}}return!0},drawTc:function(t){t=t?t:"V1",e.tc.name=t,this.clearTc();var r=e.tc;r.coordinate.x=0,r.coordinate.y=0,r.line=1;var n=72*e.rate*e.tc.pxPerData,c=e.ecgDom.tc.width,i=e.ecgDom.tc.height,a=Math.ceil(n/c)+1,l=Math.floor(i/a);r.space=l;var d=e.tc.coordinate,s=e.context.tcContext;s.beginPath(),s.lineWidth=e.theme.lineWidth,s.strokeStyle=e.theme.line;for(var f=e.ecgData,h=f.ecgPartBlocks,g=f.avgLead,u=o.getEcgIndex(t),m=0;m<18;m++){if(!o.isArray(h)||0==h.length)return console.error("ecgPartBlocks is not an Array or the array is empty."),!1;for(var v=h[m],p=v.ecgPartBlockData,x=p[u],y=0;y<x.length;y++){var b=x[y],w=d.x+r.pxPerData;w>c&&(r.line++,w-=c,d.x=0,d.y+=r.line*l),g&&(b-=g[u]),b*=r.pxPerMv,b=r.line*l-b,0==d.x&&(d.y=b),s.moveTo(d.x,d.y+.5),s.lineTo(w,b+.5),d.x=w,d.y=b}}s.stroke()},drawSelectedArea:function(t,r){if("number"!=typeof t)throw new TypeError("function drawSelectedArea, param x: number required, but "+typeof t+" given");if("number"!=typeof r)throw new TypeError("function drawSelectedArea, param lineNum: number required, but "+typeof t+" given");var o=e.tc,n=o.sWidth,c=o.sHeight;t-=.5;var i=r*o.space-c/2-.5,a=e.context.tcContext;a.beginPath(),a.strokeStyle=e.theme.optionColor,a.rect(t,i,n,c),a.stroke()},selectTc:function(t){var r=t.pageX,n=t.pageY,i=o.getCoordinateInCanvas(r,n),a=o.getLineNumInTc(i.y);"number"==typeof a&&a>0&&(c.drawTc(e.tc.name),c.drawSelectedArea(i.x,a)),o.moveSelectedAreaIntoView(i.x,a)}};return{doc:e,css:t,tCss:r,chart:c,util:n,inner:o}}();